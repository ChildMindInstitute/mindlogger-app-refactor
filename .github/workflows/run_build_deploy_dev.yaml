name: Build and Deploy to Dev

on:
  push:
    branches:
      - dev

concurrency:
  cancel-in-progress: true
  group: mobile-build-deploy-uat

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Get git short sha
        id: sha
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    outputs:
      short-sha: ${{ steps.sha.outputs.sha }}

  build-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Trigger Bitrise Build
        run: |
          curl https://app.bitrise.io/app/${{ secrets.BITRISE_APP_SLUG }}/build/start.json -L \
            --data '{"build_params":{"branch":"dev","pipeline_id":"start_dev"},"hook_info":{"build_trigger_token":"${{ secrets.BITRISE_BUILD_TOKEN }}","type":"bitrise"},"triggered_by":"gha"}' \
            -H "Content-Type: application/json"
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::917902836630:role/ssm-versions-oidc-github-role
          role-session-name: OIDC-GHA-session-version
          aws-region: us-east-1
      - name: Store version in SSM
        run: |
          aws ssm put-parameter \
                  --name "/curious/app/mobile/uat/version" \
                  --value "${{ needs.version.outputs.short-sha }}" \
                  --type "String" \
                  --overwrite
